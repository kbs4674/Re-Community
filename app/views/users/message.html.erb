<div class="board hidden-xs-down" style="background: url('/img/title_img1.jpg') no-repeat fixed; background-size: 100% 70%; background-position:0px -180px;">
    <div class="container" align="left">
        <%= link_to "곰두리 우체부", users_message_path, class: "post_title" %>
    </div>
</div>
<div class="board_mobile hidden-sm-up" style="background: url('/img/title_img1.jpg') no-repeat center center/cover scroll;">
    <%= link_to "곰두리 우체부", users_message_path, class: "post_title" %>
</div>
<% #경고메세지 출력 (아이디, 비밀번호 잘못 칠 시 등등...) %>
<% if alert %>
    <div class="alert alert-danger tlert-dismissible fade show text-center" style="padding: 10px; background-color: #FF4B5C; color: white; border-radius: 0; margin-bottom: 0; border: 0">
    <%= alert %>
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    <% elsif notice %>
    <div class="alert alert-danger tlert-dismissible fade show text-center" style="padding: 10px; background-color: #43AC6A; color: white; border-radius: 0; margin-bottom: 0; border: 0">
    <%= notice %>
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
<% end %>

<div class="container" style="margin-top: 50px;">
    <div class="row">
        <div class="hidden-sm-up col-12">
            <div class="panel-heading">
                <%= link_to "javascript:function()", :onclick => "showHide('user_search')", :onfocus => "this.blur()" do %>
                    <h3 class="panel-title">
                        유저 목록/검색<i class="fas fa-sort-down"></i>
                    </h3>
                <% end %>
            </div>
            <div id="user_search" style="display:none;">
                <div align="center" style="margin-top: 20px;" id="scrollable-dropdown-menu">
                    <input class="typeahead form-control" type="text" placeholder="검색">
                </div>
                <div style="margin-top: 150px;"></div>
            </div>
        <hr/>
        </div>
        
        
        <div class="col-sm-7 col-md-9">
            <ul id="conversations-list">
                <% @conversations.each do |conversation| %>
                    <%= render 'conversations/conversation', conversation: conversation, user: current_user %>
                    <div style="margin-top: 30px;"></div>
                <% end %>
            </ul>
        </div>
        
        <div class="hidden-xs-down col-sm-5 col-md-3">
            <div class="panel-heading">
                <h3 class="panel-title">유저 목록</h3>
            </div>
            
            <div id="scrollable-dropdown-menu">
                <input class="typeahead form-control" type="text" placeholder="검색">
            </div>
            
            <div class="panel-body" style="margin-top: 150px;">
    	        <hr/>
                <ul>
                    <h3 class="panel-title" style="color: #2687dc;">7일 간 메세지 기록</h3>
                    <% @users.each do |user| %>
                        <% Message.all.uniq(&:user_id).each do |x| %>
                            <% if (user.id == x.user.id) && Time.now - x.created_at <= 1.minutes %>
                                <li><%= link_to user.nickname.truncate(15, omission: '...'), conversations_path(user_id: user), remote: true, method: :post %></li>
                            <% end %>
                        <% end %>
                    <% end %>
                </ul>
            </div>
            
	        <div class="panel-body" style="margin-top: 150px;">
    	        <hr/>
                <ul>
                    <h3 class="panel-title" style="color: #2687dc;">Admin</h3>
                    <% @users.each do |user| %>
                        <% if user.has_role? :admin %>
                            <li><%= link_to user.nickname.truncate(15, omission: '...'), conversations_path(user_id: user), remote: true, method: :post %></li>
                        <% end %>
                    <% end %>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    var links =
    [
        <% @users.each do |user| %>
            {name: "<%= user.nickname %>"},
        <% end %>
    ];

var source = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  local: links
});

source.initialize();

$('#scrollable-dropdown-menu .typeahead').typeahead(null, {
  displayKey: 'name',
  limit: 5,
  source: source.ttAdapter(),
  templates: {
    empty: [
      '<div style="margin-top: 15px;" class="empty-message">',
      '해당 계정은 없습니다.',
      '</div>'
    ].join('\n'),
      suggestion: Handlebars.compile('<div align="left" style="margin-top: 15px;"><% @users.each do |user| %><%= link_to "#{user.nickname.truncate(12, omission: '...')}<br/>".html_safe, conversations_path(user_id: user), remote: true, method: :post %><% end %></div>')
  }
});
</script>